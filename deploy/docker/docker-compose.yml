version: "3.8"

services:
  db:
    image: timescale/timescaledb-postgis:latest-pg14
    environment:
      POSTGRES_USER: jarvis
      POSTGRES_PASSWORD: example
      POSTGRES_DB: jarvis
    volumes:
      - db_data:/var/lib/postgresql/data

  jarvis:
    build:
      # Build the image from the project root.  The Dockerfile is located under
      # deploy/docker relative to the context.  This keeps the Docker
      # configuration in a dedicated directory while still copying the full
      # source tree into the image.
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    depends_on:
      - db
    environment:
      DATABASE_URL: postgres://jarvis:example@db:5432/jarvis
      # Default LLM mode is fake for safety; override to live in production
      LLM_MODE: "fake"
    volumes:
      # Persist artifacts outside the container
      - ../../artifacts:/app/artifacts
      # Mount scripts for use by the daily scan
      - ../../scripts:/app/scripts
    command: sleep infinity

  scheduler:
    build:
      context: ../..
      dockerfile: deploy/docker/Dockerfile
    depends_on:
      - db
    environment:
      DATABASE_URL: postgres://jarvis:example@db:5432/jarvis
      JARVIS_SCAN_TZ: America/New_York
      # Cron schedule: 10:15 AM New York time on weekdays
      JARVIS_SCAN_CRON: "15 10 * * 1-5"
      LLM_MODE: "fake"
    volumes:
      - ../../artifacts:/app/artifacts
      - ../../scripts:/app/scripts
      # Mount the deploy directory so the scheduler entrypoint is available
      - ../../deploy/docker:/app/deploy/docker
    # Use a dedicated entrypoint script to set up cron with proper timezone handling
    command: bash -lc "/app/deploy/docker/scheduler_entrypoint.sh"

volumes:
  db_data: